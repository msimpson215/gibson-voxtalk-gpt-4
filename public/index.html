<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gibson Voice Demo</title>

  <style>
    :root{
      --ink:#0b1220;
      --muted:#5b6476;
      --line:rgba(255,255,255,.28);
      --panelLine:rgba(255,255,255,.22);
      --shadow: 0 14px 40px rgba(0,0,0,.14);
      --radius:16px;
      --gold:#d4a23a; /* warmer Gibson-ish accent */
      --ok:#16a34a;
      --bad:#dc2626;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--font);
      color:#fff;
      overflow:hidden;
      background:#111;
    }

    /* Background */
    .bg{
      position:fixed; inset:0;
      background:url("/assets/gibson-bg.png") center/cover no-repeat;
      transform: translateZ(0);
    }
    .scrim{
      position:fixed; inset:0;
      background: rgba(0,0,0,.12); /* very light ‚Äî keeps background ‚Äúalive‚Äù */
      pointer-events:none;
    }

    /* --- ‚ÄúNav tab‚Äù style button (integrated) --- */
    .navWrap{
      position:fixed;
      top: 14px;
      right: 16px;
      z-index: 50;
      display:flex;
      gap: 14px;
      align-items:center;
    }

    /* This is intentionally ‚Äúwebsite tab‚Äù style: no bubble, no shadow, inherits font */
    .navTab{
      appearance:none;
      border: none;
      background: transparent;
      color: rgba(255,255,255,.92);
      font: inherit;
      font-weight: 700;
      letter-spacing: .2px;
      padding: 8px 10px;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap: 8px;
      border-radius: 10px;
      line-height: 1;
      text-transform: none;
    }
    .navTab:hover{
      background: rgba(255,255,255,.06);
    }
    .navTab:active{
      transform: translateY(1px);
    }
    .navDot{
      width:8px; height:8px; border-radius:999px;
      background: var(--gold);
      box-shadow: 0 0 0 4px rgba(212,162,58,.15);
    }
    .navSub{
      font-weight: 600;
      opacity: .84;
      font-size: 12px;
      margin-left: 8px;
      white-space:nowrap;
    }

    /* --- Center mic bubble --- */
    .micBubble{
      position:fixed;
      left:50%;
      top:50%;
      transform: translate(-50%,-50%);
      z-index: 60;
      width: 108px;
      height: 108px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.25);
      background: rgba(10,10,10,.28);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      display:none;
      cursor:pointer;
      user-select:none;
      overflow:hidden;
    }
    .micBubble.show{ display:grid; place-items:center; }

    .micBubble.on{
      border-color: rgba(212,162,58,.55);
      box-shadow: 0 18px 60px rgba(0,0,0,.25);
    }

    .micImg{
      width: 74px;
      height: 74px;
      object-fit: contain;
      display:block;
      filter: drop-shadow(0 10px 14px rgba(0,0,0,.28));
    }
    .micFallback{
      font-size: 34px;
      opacity: .92;
    }

    /* --- Cards panel (left/below mic) --- */
    .cardsPanel{
      position:fixed;
      left:50%;
      top:50%;
      transform: translate(calc(-50% - 190px), calc(-50% + 90px));
      z-index: 55;
      width: min(520px, calc(100vw - 24px));
      max-height: min(380px, calc(100vh - 160px));
      overflow:auto;

      border-radius: 18px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(10,10,10,.30);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      display:none;
      padding: 12px;
    }
    .cardsPanel.show{ display:block; }

    .cardsTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .cardsTitle{
      font-weight: 900;
      letter-spacing: .2px;
      font-size: 13px;
      opacity: .95;
    }
    .cardsActions{
      display:flex;
      gap: 8px;
      align-items:center;
    }
    .smallBtn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.20);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      border-radius: 999px;
      padding: 8px 10px;
      cursor:pointer;
      font: inherit;
      font-weight: 800;
      font-size: 12px;
      white-space:nowrap;
    }
    .smallBtn:hover{ background: rgba(255,255,255,.10); }
    .smallBtn:active{ transform: translateY(1px); }

    #prodGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }

    .prodCard{
      display:grid;
      grid-template-columns: 86px 1fr;
      gap: 10px;
      padding: 10px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
    }

    .thumb{
      width:86px; height:86px;
      border-radius: 14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      display:grid; place-items:center;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }

    .prodCard h4{
      margin:0 0 4px 0;
      font-size: 13px;
      line-height: 1.2;
      font-weight: 900;
    }
    .meta{
      margin:0;
      font-size: 12px;
      opacity: .82;
      line-height: 1.25;
    }
    .priceRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-top: 8px;
    }
    .price{
      font-weight: 900;
      font-size: 13px;
      opacity: .95;
    }
    .cardBtns{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .linkBtn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      border-radius: 999px;
      padding: 7px 10px;
      cursor:pointer;
      font: inherit;
      font-weight: 900;
      font-size: 12px;
      white-space:nowrap;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .linkBtn:hover{ background: rgba(255,255,255,.10); }
    .linkBtn:active{ transform: translateY(1px); }

    /* Log panel (minimal, optional) */
    .logPanel{
      position:fixed;
      left:16px;
      bottom:16px;
      z-index: 40;
      width: min(420px, calc(100vw - 32px));
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      padding: 10px 12px;
      display:none;
    }
    .logPanel.show{ display:block; }
    .log{
      max-height: 140px;
      overflow:auto;
      font-size: 12px;
      line-height: 1.35;
      opacity: .92;
    }
    .log p{ margin:0 0 6px 0; }
    .who{ font-weight: 900; }
    .muted{ opacity: .78; font-weight: 700; }

    /* Tiny text input (fallback) */
    .textRow{
      display:flex;
      gap:10px;
      margin-top: 8px;
    }
    #textIn{
      flex: 1;
      padding: 9px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.94);
      outline:none;
      font: inherit;
      font-size: 12px;
    }
    #sendBtn{
      padding: 9px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      color:#fff;
      font: inherit;
      font-weight: 900;
      font-size: 12px;
      cursor:pointer;
    }
    #sendBtn:hover{ background: rgba(255,255,255,.14); }
    #sendBtn:active{ transform: translateY(1px); }

    @media (max-width: 760px){
      .cardsPanel{
        transform: translate(-50%, calc(-50% + 120px));
      }
    }
  </style>
</head>

<body>
  <div class="bg"></div>
  <div class="scrim"></div>

  <!-- Top integrated ‚Äútab‚Äù -->
  <div class="navWrap">
    <button class="navTab" id="navTab" aria-label="Try our new AI Gibson Specialist">
      <span class="navDot"></span>
      <span>Gibson Specialist</span>
      <span class="navSub">Try our new AI Gibson Specialist</span>
    </button>
  </div>

  <!-- Center mic bubble -->
  <div class="micBubble" id="micBubble" title="Click to talk">
    <img class="micImg" id="micImg" src="/assets/mic.png" alt="Gibson mic" onerror="this.style.display='none'; document.getElementById('micFallback').style.display='block';">
    <div class="micFallback" id="micFallback" style="display:none;">üéôÔ∏è</div>
  </div>

  <!-- Cards panel -->
  <div class="cardsPanel" id="cardsPanel" aria-label="Product results">
    <div class="cardsTop">
      <div class="cardsTitle" id="cardsTitle">Matches</div>
      <div class="cardsActions">
        <button class="smallBtn" id="moreBtn">More like these</button>
        <button class="smallBtn" id="hideBtn">Hide</button>
      </div>
    </div>
    <div id="prodGrid"></div>
  </div>

  <!-- Minimal log + text fallback (hidden by default) -->
  <div class="logPanel" id="logPanel">
    <div class="log" id="log"></div>
    <div class="textRow">
      <input id="textIn" type="text" placeholder='Type: show Les Paul Custom black' />
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <script src="/gipson.js"></script>

  <script>
    const navTab = document.getElementById("navTab");
    const micBubble = document.getElementById("micBubble");
    const cardsPanel = document.getElementById("cardsPanel");
    const hideBtn = document.getElementById("hideBtn");
    const moreBtn = document.getElementById("moreBtn");
    const cardsTitle = document.getElementById("cardsTitle");
    const logPanel = document.getElementById("logPanel");
    const textIn = document.getElementById("textIn");
    const sendBtn = document.getElementById("sendBtn");

    // If you ever want to see logs, flip this to true:
    const SHOW_LOG_PANEL = false;
    if (SHOW_LOG_PANEL) logPanel.classList.add("show");

    function looksLikeProductRequest(s){
      const t = String(s||"").toLowerCase();
      return (
        t.includes("show") ||
        t.includes("pull up") ||
        t.includes("bring up") ||
        t.includes("list") ||
        t.includes("browse") ||
        t.includes("les paul") ||
        t.includes("sg") ||
        t.includes("custom") ||
        t.includes("reissue") ||
        t.includes("standard")
      );
    }

    function extractQueryFromUserSpeech(s){
      // Keep it simple: pass the speech as the query
      // (works great with the scoring search in gipson.js)
      return String(s||"").trim();
    }

    // UI: tab toggles mic bubble
    navTab.addEventListener("click", () => {
      micBubble.classList.toggle("show");
      if (micBubble.classList.contains("show") && window.__gipson_loadCatalog) {
        window.__gipson_loadCatalog();
      }
    });

    // Cards panel controls
    hideBtn.addEventListener("click", () => {
      cardsPanel.classList.remove("show");
    });
    moreBtn.addEventListener("click", () => {
      if (window.__gipson_moreResults) window.__gipson_moreResults();
      cardsPanel.classList.add("show");
    });

    // -------- Voice (WebRTC Realtime) --------
    let pc=null, dc=null, localStream=null, audioEl=null, starting=false;

    function hardReset(){
      try{ if(dc) dc.close(); }catch{}
      dc=null;
      try{
        if(pc){
          for(const s of pc.getSenders()){
            try{ if(s.track) s.track.stop(); }catch{}
          }
        }
      }catch{}
      try{ if(pc) pc.close(); }catch{}
      pc=null;

      if(localStream){
        localStream.getTracks().forEach(t=>{ try{ t.stop(); }catch{} });
      }
      localStream=null;

      if(audioEl){
        try{ audioEl.srcObject=null; }catch{}
        try{ audioEl.remove(); }catch{}
      }
      audioEl=null;
    }

    function stopVoice(){
      starting=false;
      micBubble.classList.remove("on");
      hardReset();
    }

    function sendEvent(obj){
      if(!dc || dc.readyState!=="open") return;
      dc.send(JSON.stringify(obj));
    }

    async function startVoice(){
      if(starting || pc) return;
      starting=true;

      micBubble.classList.add("on");
      hardReset();

      pc = new RTCPeerConnection();

      audioEl = document.createElement("audio");
      audioEl.autoplay = true;
      pc.ontrack = (e)=>{ audioEl.srcObject = e.streams[0]; };

      localStream = await navigator.mediaDevices.getUserMedia({ audio:true });
      pc.addTrack(localStream.getTracks()[0]);

      dc = pc.createDataChannel("oai-events");

      let currentText="";

      dc.onopen = () => {
        starting=false;

        // Strict hinting helps, but we won't depend on it for cards
        sendEvent({
          type:"session.update",
          session:{
            instructions:
              "You are Gibson's friendly, no-pressure guitar salesperson. Always respond in English. " +
              "Keep answers short. If user wants to see products, include exactly one [[SHOW: query]] marker."
          }
        });

        sendEvent({
          type:"response.create",
          response:{
            modalities:["audio","text"],
            instructions:"Greet the user and ask what guitar they want. Keep it short."
          }
        });
      };

      dc.onmessage = (e) => {
        try{
          const evt = JSON.parse(e.data);

          // 1) USER TRANSCRIPT ‚Äî trigger cards from what YOU say (reliable)
          if(evt.type==="input_audio_transcription.completed" && evt.text){
            const userText = evt.text;
            if(window.__gipson_addLine) window.__gipson_addLine("You", userText);

            if(looksLikeProductRequest(userText)){
              const q = extractQueryFromUserSpeech(userText);
              if(window.__gipson_showProducts) window.__gipson_showProducts(q);
              cardsTitle.textContent = "Matches";
              cardsPanel.classList.add("show");
            }
          }

          // 2) ASSISTANT TEXT ‚Äî still parse SHOW if present (bonus)
          if(evt.type==="response.output_text.delta" && typeof evt.delta==="string"){
            currentText += evt.delta;
          }
          if(evt.type==="response.output_text.done"){
            const txt = (evt.text || currentText || "").trim();
            currentText="";
            if(txt && window.__gipson_addLine) window.__gipson_addLine("Gibson", txt);

            const m = txt.match(/\[\[\s*SHOW\s*:\s([^\]]+)\]\]/i);
            if(m && m[1] && window.__gipson_showProducts){
              window.__gipson_showProducts(m[1].trim());
              cardsPanel.classList.add("show");
            }
          }
        }catch{}
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      const sdpResp = await fetch("/session", {
        method:"POST",
        body: offer.sdp,
        headers:{ "Content-Type":"application/sdp" }
      });

      if(!sdpResp.ok){
        console.error("Session failed:", await sdpResp.text());
        stopVoice();
        return;
      }

      const answer = { type:"answer", sdp: await sdpResp.text() };
      await pc.setRemoteDescription(answer);
    }

    // Clicking mic bubble toggles voice
    micBubble.addEventListener("click", async () => {
      if(pc) return stopVoice();
      try { await startVoice(); }
      catch(e){ console.error(e); stopVoice(); }
    });

    // Text fallback (optional)
    async function handleSend(){
      const txt = textIn.value.trim();
      if(!txt) return;
      textIn.value="";

      if(window.__gipson_addLine) window.__gipson_addLine("You", txt);

      if(looksLikeProductRequest(txt)){
        const q = extractQueryFromUserSpeech(txt);
        if(window.__gipson_showProducts) window.__gipson_showProducts(q);
        cardsPanel.classList.add("show");
      }
    }
    sendBtn.addEventListener("click", handleSend);
    textIn.addEventListener("keydown", (e)=>{ if(e.key==="Enter") handleSend(); });

    // Preload catalog quietly
    if(window.__gipson_loadCatalog) window.__gipson_loadCatalog();
  </script>
</body>
</html>
