<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gibson Voice Demo</title>

  <style>
    :root{
      /* TAB placement: put it just LEFT of ‚ÄúGarage‚Äù */
      --tab-right: 360px; /* bigger = moves LEFT */
      --tab-top: 14px;    /* bigger = moves DOWN */

      /* Tab styling (integrated) */
      --tab-size: 14px;
      --tab-weight: 800;
      --green:#2b7a2b;
      --gold:#d4a23a;

      /* Mic bubble */
      --mic-size: 126px;
      --mic-img: 78px;

      /* Panel */
      --shadow: 0 14px 40px rgba(0,0,0,.14);
      --font: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      font-family:var(--font);
      overflow:hidden;
      background:#111;
    }

    .bg{
      position:fixed; inset:0;
      background:url("/assets/gibson-bg.png") center/cover no-repeat;
      transform: translateZ(0);
    }
    .scrim{
      position:fixed; inset:0;
      background: rgba(255,255,255,0.06);
      pointer-events:none;
    }

    /* Green inserted tab */
    .navWrap{
      position:fixed;
      top: var(--tab-top);
      right: var(--tab-right);
      z-index: 60;
      display:flex;
      align-items:center;
    }
    .navTab{
      appearance:none;
      border:none;
      background:transparent;
      font: inherit;
      padding: 6px 8px;
      cursor:pointer;
      line-height: 1;
      display:flex;
      align-items:center;
      gap: 10px;
      border-radius: 10px;
      -webkit-font-smoothing: antialiased;
      text-rendering: geometricPrecision;
    }
    .navTab:hover{ background: rgba(0,0,0,.04); }
    .navTab:active{ transform: translateY(1px); }

    .navDot{
      width:7px; height:7px;
      border-radius:999px;
      background: var(--gold);
      box-shadow: 0 0 0 3px rgba(212,162,58,.12);
      flex: 0 0 auto;
    }
    .navText{
      font-weight: var(--tab-weight);
      font-size: var(--tab-size);
      color: var(--green);
      white-space:nowrap;
    }

    /* Mic circle */
    .micBubble{
      position:fixed;
      left:50%;
      top:50%;
      transform: translate(-50%,-50%);
      z-index: 65;

      width: var(--mic-size);
      height: var(--mic-size);
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.20);
      background: rgba(10,10,10,.18);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);

      display:none;
      cursor:pointer;
      user-select:none;
      overflow:hidden;
      padding:0;
    }
    .micBubble.show{ display:grid; place-items:center; }
    .micBubble.on{
      border-color: rgba(212,162,58,.55);
      box-shadow: 0 18px 60px rgba(0,0,0,.25);
    }

    .micImg{
      width: var(--mic-img);
      height: var(--mic-img);
      object-fit: contain;
      display:block;
      filter: drop-shadow(0 10px 14px rgba(0,0,0,.28));
    }
    .micFallback{
      display:none;
      place-items:center;
      font-size: 44px;
      opacity: .92;
      color:#fff;
    }

    /* Product panel */
    .cardsPanel{
      position:fixed;
      left:50%;
      top:50%;
      transform: translate(-50%, 118px);
      z-index: 64;

      width: min(720px, calc(100vw - 24px));
      max-height: min(520px, calc(100vh - 240px));
      overflow:auto;

      border-radius: 18px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(10,10,10,.26);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      display:none;
      padding: 12px;
      color:#fff;
    }
    .cardsPanel.show{ display:block; }

    .cardsTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .cardsTitle{
      font-weight: 900;
      font-size: 13px;
      opacity: .95;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 72%;
    }
    .cardsActions{
      display:flex;
      gap: 8px;
      align-items:center;
    }
    .smallBtn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.20);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      border-radius: 999px;
      padding: 8px 10px;
      cursor:pointer;
      font: inherit;
      font-weight: 800;
      font-size: 12px;
      white-space:nowrap;
    }
    .smallBtn:hover{ background: rgba(255,255,255,.10); }

    #prodGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    /* These classes match the gipson.js cards you already have */
    .prodCard{
      display:grid;
      grid-template-columns: 92px 1fr;
      gap: 10px;
      align-items: start;
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 16px;
      padding: 10px;
      background: rgba(0,0,0,.18);
    }
    .thumb{
      width: 92px;
      height: 92px;
      border-radius: 12px;
      overflow:hidden;
      background: rgba(255,255,255,.06);
      display:grid;
      place-items:center;
    }
    .thumb img{ width:100%; height:100%; object-fit: cover; }
    .prodCard h4{ margin: 0 0 6px 0; font-size: 14px; font-weight: 900; }
    .meta{ margin:0 0 8px 0; font-size: 12px; opacity: .82; }
    .priceRow{ display:flex; justify-content:space-between; align-items:center; gap: 10px; }
    .price{ font-weight: 900; font-size: 14px; }
    .cardBtns{ display:flex; gap: 8px; align-items:center; }
    .linkBtn{
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 12px;
      font-weight: 900;
      text-decoration:none;
      cursor:pointer;
    }
    .linkBtn:hover{ background: rgba(255,255,255,.10); }

    /* EVENT TRACER (this is the key diagnostic) */
    .trace{
      position: fixed;
      left: 14px;
      bottom: 12px;
      z-index: 90;
      font-size: 12px;
      color: #fff;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.16);
      padding: 10px 12px;
      border-radius: 12px;
      backdrop-filter: blur(8px);
      max-width: min(740px, calc(100vw - 28px));
      display:none;
    }
    .trace.show{ display:block; }
    .trace .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .trace b{ color: #fef08a; }
  </style>
</head>

<body>
  <div class="bg"></div>
  <div class="scrim"></div>

  <div class="navWrap">
    <button class="navTab" id="navTab" type="button" aria-label="Try our new AI Gibson Specialist">
      <span class="navDot" aria-hidden="true"></span>
      <span class="navText">Try our new AI Gibson Specialist</span>
    </button>
  </div>

  <button class="micBubble" id="micBubble" type="button" title="Click to talk" aria-label="Click to talk">
    <img class="micImg" id="micImg" src="/assets/mic.png" alt=""
      onerror="this.style.display='none'; document.getElementById('micFallback').style.display='grid';">
    <span class="micFallback" id="micFallback" aria-hidden="true">üéôÔ∏è</span>
  </button>

  <section class="cardsPanel" id="cardsPanel" aria-label="Product results">
    <header class="cardsTop">
      <div class="cardsTitle" id="cardsTitle">Matches</div>
      <div class="cardsActions">
        <button class="smallBtn" id="moreBtn" type="button">More</button>
        <button class="smallBtn" id="hideBtn" type="button">Hide</button>
      </div>
    </header>
    <div id="prodGrid"></div>
  </section>

  <div class="trace" id="trace">
    <div><b>Events:</b> <span class="mono" id="traceLine">‚Äî</span></div>
    <div style="opacity:.8;margin-top:4px;">If ‚Äúshow les paul custom‚Äù does nothing, this line tells us which event is actually arriving.</div>
  </div>

  <script src="/gipson.js"></script>

  <script>
    const navTab = document.getElementById("navTab");
    const micBubble = document.getElementById("micBubble");
    const cardsPanel = document.getElementById("cardsPanel");
    const cardsTitle = document.getElementById("cardsTitle");
    const moreBtn = document.getElementById("moreBtn");
    const hideBtn = document.getElementById("hideBtn");

    const trace = document.getElementById("trace");
    const traceLine = document.getElementById("traceLine");

    function showTrace(s){
      traceLine.textContent = s;
      trace.classList.add("show");
      clearTimeout(trace._t);
      trace._t = setTimeout(()=>trace.classList.remove("show"), 6500);
    }

    function showCards(query, source){
      const q = String(query || "").trim();
      if(!q) return;
      cardsTitle.textContent = `${source}: ${q}`;
      cardsPanel.classList.add("show");
      window.__gipson_showProducts?.(q);
    }

    navTab.addEventListener("click", () => {
      micBubble.classList.toggle("show");
      if (micBubble.classList.contains("show")) window.__gipson_loadCatalog?.();
    });

    hideBtn.addEventListener("click", () => cardsPanel.classList.remove("show"));
    moreBtn.addEventListener("click", () => {
      window.__gipson_moreResults?.();
      cardsPanel.classList.add("show");
    });

    // -------- Voice ----------
    let pc=null, dc=null, localStream=null, audioEl=null, starting=false;

    function hardReset(){
      try{ if(dc) dc.close(); }catch{}
      dc=null;

      try{
        if(pc){
          for(const s of pc.getSenders()){
            try{ if(s.track) s.track.stop(); }catch{}
          }
        }
      }catch{}
      try{ if(pc) pc.close(); }catch{}
      pc=null;

      if(localStream){
        localStream.getTracks().forEach(t=>{ try{ t.stop(); }catch{} });
      }
      localStream=null;

      if(audioEl){
        try{ audioEl.srcObject=null; }catch{}
        try{ audioEl.remove(); }catch{}
      }
      audioEl=null;
    }

    function stopVoice(){
      starting=false;
      micBubble.classList.remove("on");
      hardReset();
      showTrace("stopped");
    }

    function sendEvent(obj){
      if(!dc || dc.readyState!=="open") return;
      dc.send(JSON.stringify(obj));
    }

    function pickTranscript(evt){
      // We accept multiple shapes so we stop guessing
      return (
        evt?.transcript ||
        evt?.text ||
        evt?.item?.content?.[0]?.transcript ||
        evt?.item?.content?.[0]?.text ||
        ""
      );
    }

    async function startVoice(){
      if(starting || pc) return;
      starting=true;
      micBubble.classList.add("on");
      hardReset();

      pc = new RTCPeerConnection();
      audioEl = document.createElement("audio");
      audioEl.autoplay = true;
      pc.ontrack = (e)=>{ audioEl.srcObject = e.streams[0]; };

      localStream = await navigator.mediaDevices.getUserMedia({ audio:true });
      pc.addTrack(localStream.getTracks()[0]);

      dc = pc.createDataChannel("oai-events");

      dc.onopen = () => {
        starting=false;
        showTrace("dc open");

        // THIS is the specific area: transcription must be enabled
        sendEvent({
          type:"session.update",
          session:{
            input_audio_transcription: { model: "whisper-1" },
            instructions:
              "You are Gibson's friendly guitar specialist. Always respond in English. Keep answers short. " +
              "When the user asks to show/browse/list/pull up a guitar, output exactly: [[SHOW: <search phrase>]]. " +
              "Do NOT say you cannot show images; the UI will show product cards with images."
          }
        });

        sendEvent({
          type:"response.create",
          response:{ modalities:["audio","text"], instructions:"Ask what guitar they want to see." }
        });
      };

      dc.onmessage = (e) => {
        try{
          const evt = JSON.parse(e.data);
          const t = evt.type || "(no type)";

          // Trace the live event types (this ends the guessing)
          showTrace(t);

          // 1) Trigger cards from YOUR transcript (reliable)
          if (
            t === "conversation.item.input_audio_transcription.completed" ||
            t === "input_audio_transcription.completed" ||
            t.includes("transcription")
          ){
            const tr = pickTranscript(evt);
            if (tr) showCards(tr, "you");
          }

          // 2) Trigger cards from assistant [[SHOW: ...]] (backup)
          if (t === "response.output_text.done" && evt.text){
            const m = String(evt.text).match(/\[\[\s*SHOW\s*:\s*([^\]]+)\]\]/i);
            if (m && m[1]) showCards(m[1].trim(), "SHOW");
          }

        }catch(_){}
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      const sdpResp = await fetch("/session", {
        method:"POST",
        body: offer.sdp,
        headers:{ "Content-Type":"application/sdp" }
      });

      if(!sdpResp.ok){
        showTrace("session failed");
        stopVoice();
        return;
      }

      const answer = { type:"answer", sdp: await sdpResp.text() };
      await pc.setRemoteDescription(answer);
      showTrace("pc connected");
    }

    micBubble.addEventListener("click", async () => {
      if(pc) return stopVoice();
      try { await startVoice(); }
      catch(_){ stopVoice(); }
    });

    // preload CSV
    window.__gipson_loadCatalog?.();
  </script>
</body>
</html>
